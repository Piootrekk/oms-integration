FROM node:24-alpine AS base
WORKDIR /app

COPY package*.json ./
COPY packages/infra/package.json ./packages/infra/
COPY packages/worker/package.json ./packages/worker/

RUN npm install --include=dev

FROM base AS build
WORKDIR /app

COPY tsconfig*.json ./
COPY packages/infra ./packages/infra
COPY packages/worker ./packages/worker

RUN npm run build --workspace packages/infra \
    && npm run build --workspace packages/worker

FROM node:24-alpine AS runtime
WORKDIR /app

COPY package*.json ./
COPY packages/infra/package.json ./packages/infra/
COPY packages/worker/package.json ./packages/worker/

RUN npm install --omit=dev

COPY --from=build /app/packages/infra/dist ./packages/infra/dist
COPY --from=build /app/packages/worker/dist ./packages/worker/dist

CMD ["npm", "run", "start:worker"]
