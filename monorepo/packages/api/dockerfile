FROM node:24-alpine AS base
WORKDIR /app

COPY package*.json ./
COPY packages/infra/package.json ./packages/infra/
COPY packages/api/package.json ./packages/api/

RUN npm install --include=dev

FROM base AS build
WORKDIR /app

COPY tsconfig*.json ./
COPY packages/infra ./packages/infra
COPY packages/api ./packages/api

RUN npm run build --workspace packages/infra \
    && npm run build --workspace packages/api

FROM node:24-alpine AS runtime
WORKDIR /app

COPY package*.json ./
COPY packages/infra/package.json ./packages/infra/
COPY packages/api/package.json ./packages/api/

RUN npm install --omit=dev 

COPY --from=build /app/packages/infra/dist ./packages/infra/dist
COPY --from=build /app/packages/api/dist ./packages/api/dist
COPY --from=build /app/packages/api/swagger.json ./packages/api/swagger.json

EXPOSE 3000
CMD ["npm", "run", "start:api"]
